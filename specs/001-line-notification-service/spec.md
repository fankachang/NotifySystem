# Feature Specification: Line 訊息通知服務

**Feature Branch**: `001-line-notification-service`  
**Created**: 2025-12-31  
**Status**: Draft  
**Input**: 使用者描述：建立一個以 Line 為主要發送管道的訊息通知服務，用於替代傳統 Nagios 簡訊發送服務，提供更即時、更經濟的告警通知方式

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速註冊並等待管理員分配群組 (Priority: P1)

使用者需要能夠透過 Line 帳號快速完成註冊，之後由管理員將使用者加入適當的群組，使用者才會開始接收該群組關聯的告警通知。

**Why this priority**: 這是系統的核心價值主張 - 讓使用者能夠快速完成身份綁定，並由管理員統一控管告警接收權限。沒有這個功能，整個系統無法運作。

**Independent Test**: 可以透過使用者點擊「使用 Line 登入」按鈕、完成 Line 授權、管理員將使用者加入群組、再發送一則告警訊息來完整測試此功能。

**Acceptance Scenarios**:

1. **Given** 使用者尚未註冊帳號，**When** 點擊「使用 Line 登入」並完成 Line 授權，**Then** 系統自動建立帳號並顯示「等待管理員分配群組」的提示頁面
2. **Given** 使用者已完成註冊但尚未被分配群組，**When** 外部系統透過 API 發送任何訊息，**Then** 該使用者不會收到任何通知
3. **Given** 使用者已被管理員加入「INFRA」群組（關聯 CRITICAL 訊息類型），**When** 外部系統透過 API 發送 CRITICAL 訊息，**Then** 使用者在 3 秒內透過 Line 收到格式化的告警訊息
4. **Given** 使用者已登入系統且已被分配群組，**When** 使用者發送測試訊息，**Then** 使用者立即透過 Line 收到測試訊息，確認通知管道正常運作

---

### User Story 2 - 群組化管理告警接收者 (Priority: P1)

管理員需要能夠將使用者分配到不同的群組（如基礎設施團隊、應用程式團隊、資料庫團隊），使用者只能接收所屬群組關聯的訊息類型，無法自行選擇訂閱。

**Why this priority**: 在企業環境中，告警接收權限必須由管理員集中控管，確保正確的人收到正確的告警。使用者不應該自行決定要接收哪些告警，這是核心的權限控管需求。

**Independent Test**: 可以透過管理員建立「基礎設施團隊」群組、將 3 位使用者加入該群組、設定群組接收 CRITICAL 和 WARNING 訊息、然後發送一則 CRITICAL 訊息來驗證所有群組成員都收到通知。

**Acceptance Scenarios**:

1. **Given** 管理員已登入後台，**When** 建立新群組並設定可接收的訊息類型，**Then** 群組成功建立且設定已儲存
2. **Given** 群組已建立，**When** 管理員將多位使用者批次加入群組，**Then** 這些使用者自動訂閱該群組關聯的所有訊息類型
3. **Given** 使用者屬於多個群組，**When** 發送符合任一群組設定的訊息，**Then** 使用者只收到一則訊息（去重處理）
4. **Given** 群組設定了來源主機篩選（如 web-server-*），**When** 發送來自 web-server-01 的告警，**Then** 群組成員收到通知；發送來自 db-server-01 的告警時則不收到

---

### User Story 3 - 外部系統整合（API 發送） (Priority: P1)

監控系統（如 Nagios、Zabbix）需要能夠透過 RESTful API 發送告警訊息到本服務，使用簡單的 JSON 格式傳遞告警內容。

**Why this priority**: 這是系統存在的主要目的 - 讓監控系統能夠發送告警。沒有這個功能，系統無法與現有監控工具整合。

**Independent Test**: 可以透過使用 curl 命令或 PowerShell 腳本呼叫 API 端點、傳遞告警訊息、並驗證訂閱該類型的使用者收到 Line 訊息來完整測試此功能。

**Acceptance Scenarios**:

1. **Given** Nagios 設定了通知命令並取得有效的 API Key，**When** Nagios 偵測到服務故障並呼叫 API 發送 CRITICAL 訊息，**Then** API 回應成功（HTTP 200）且訂閱者在 3 秒內收到通知
2. **Given** API 請求包含無效的 API Key，**When** 外部系統呼叫 API，**Then** 系統回應 401 Unauthorized 錯誤
3. **Given** API 請求包含無效的訊息類型（如 "CRITICALX"），**When** 外部系統呼叫 API，**Then** 系統回應 400 Bad Request 並說明錯誤原因
4. **Given** API 請求指定 targetGroups 為「INFRA」，**When** 發送訊息，**Then** 只有「INFRA」群組的成員收到通知，其他群組成員不會收到
5. **Given** 同一告警在短時間內重複發送，**When** 群組設定了重複告警間隔（30 分鐘），**Then** 群組成員在 30 分鐘內不會收到相同告警的重複通知

---

### User Story 4 - 後台管理與監控 (Priority: P2)

管理員需要能夠透過 Web 後台介面管理使用者、群組、訊息類型、設定群組的接收規則（時段、重複告警等）、查看發送歷史、以及產生統計報表。

**Why this priority**: 後台管理功能讓管理員能夠有效維運系統。由於所有設定都由管理員控制，後台管理介面的重要性大幅提升。

**Independent Test**: 可以透過管理員登入後台、建立新群組、設定群組的接收時段、將使用者加入群組、查看過去 7 天的發送統計報表來驗證管理功能完整性。

**Acceptance Scenarios**:

1. **Given** 管理員使用預設帳號（ADMIN/ADMIN）首次登入，**When** 登入成功，**Then** 系統強制要求修改密碼
2. **Given** 管理員已登入後台，**When** 查看使用者列表，**Then** 顯示所有已註冊的使用者、他們的群組歸屬、最後登入時間、以及帳號狀態
3. **Given** 管理員建立新群組，**When** 設定群組的接收時段為 09:00-18:00，**Then** 該群組成員只會在此時段內收到通知
4. **Given** 管理員查看統計報表，**When** 選擇過去 30 天的週報，**Then** 顯示每日發送量趨勢圖、各類型訊息分布、發送成功率、以及尖峰時段分析

---

### User Story 5 - API Key 管理 (Priority: P2)

管理員需要能夠為不同的監控系統建立專用的 API Key，並能夠隨時撤銷或更新權限。

**Why this priority**: 安全性是企業系統的重要需求，能夠管理 API Key 可以確保只有授權的系統能夠發送訊息，並在 Key 洩漏時快速撤銷。

**Independent Test**: 可以透過管理員建立新的 API Key（命名為「Nagios Production」）、複製 Key 並使用它發送訊息、然後撤銷該 Key 並驗證後續請求被拒絕來完整測試此功能。

**Acceptance Scenarios**:

1. **Given** 管理員已登入後台，**When** 建立新的 API Key 並命名為「Nagios Production」，**Then** 系統產生唯一的 Key 並顯示（僅此一次），管理員可以複製使用
2. **Given** API Key 已建立，**When** 使用該 Key 呼叫 API，**Then** 系統記錄最後使用時間
3. **Given** 管理員發現某個 API Key 可能洩漏，**When** 撤銷該 Key，**Then** 使用該 Key 的所有後續請求立即被拒絕（HTTP 401）
4. **Given** 管理員查看 API Key 列表，**When** 檢視每個 Key 的詳情，**Then** 顯示 Key 的名稱、建立時間、最後使用時間、以及狀態（啟用/停用）

---

### Edge Cases

- **當使用者取消 Line 好友關係時**：系統應標記該使用者的 Line 綁定為無效，並在後台顯示警告。當嘗試發送訊息時，應記錄失敗原因並通知管理員。
- **當 Line API 服務暫時無法使用時**：系統應啟用重試機制（1秒、5秒、30秒間隔重試 3 次），若仍失敗則將訊息標記為失敗並記錄錯誤。
- **當同一使用者同時屬於多個群組且都訂閱相同訊息類型時**：系統應進行去重處理，確保使用者只收到一則訊息，不會重複發送。
- **當訊息內容包含特殊字元或超長文字時**：系統應進行內容驗證和清理，避免 Line API 拒絕發送。若內容過長（超過 Line 限制），應自動截斷並添加「...（內容已截斷）」提示。
- **當系統在尖峰時段（如多台主機同時故障）收到大量訊息時**：系統應使用非同步批次處理機制，確保 API 能夠快速回應，並在背景完成訊息發送。
- **當管理員設定了衝突的群組時間條件時**（如接收時段 09:00-18:00，但靜音時段為全天）：系統應在儲存設定時進行驗證，提示管理員設定衝突並拒絕儲存。
- **當 API 請求沒有指定 targetGroups 時**：系統應發送給所有訂閱該訊息類型的使用者（預設行為）。
- **當資料庫連線失敗時**：系統應回應 503 Service Unavailable，並記錄錯誤日誌。
- **當使用者註冊後尚未被管理員分配到任何群組時**：系統不會發送任何訊息給該使用者，使用者在介面上會看到「等待管理員分配群組」的提示。

## Requirements *(mandatory)*

### Functional Requirements

#### 使用者認證與管理

- **FR-001**: 系統必須支援透過 Line Login OAuth 2.0 進行使用者登入和註冊，無需帳號密碼
- **FR-002**: 系統必須在使用者首次透過 Line 登入時自動建立使用者帳號，並儲存 Line User ID、顯示名稱、頭像 URL
- **FR-003**: 系統必須產生 JWT Token 作為使用者的認證憑證，有效期為 7 天
- **FR-004**: 系統必須支援 JWT Token 刷新機制，允許使用者在 Token 過期前刷新
- **FR-005**: 系統必須記錄使用者的登入歷史，包括登入時間、IP 位址、User Agent
- **FR-006**: 使用者必須能夠查看和更新自己的顯示名稱
- **FR-007**: 使用者必須能夠查看自己所屬的群組列表

#### 管理員功能

- **FR-008**: 系統必須提供預設管理員帳號（帳號：ADMIN，密碼：ADMIN），首次登入時強制修改密碼
- **FR-009**: 管理員必須能夠透過帳號密碼登入後台管理介面，獨立於 Line Login
- **FR-010**: 管理員必須能夠查看所有註冊使用者的列表、詳細資訊、群組歸屬、以及帳號狀態
- **FR-011**: 管理員必須能夠停用或啟用使用者帳號，停用後使用者無法登入且不會收到通知
- **FR-012**: 管理員必須能夠指定其他使用者為管理員，但不能修改其他管理員的權限
- **FR-013**: 超級管理員必須能夠管理所有管理員帳號

#### 群組管理

- **FR-014**: 管理員必須能夠建立新群組，包括群組代碼（唯一）、名稱、說明、以及關聯的訊息類型
- **FR-015**: 管理員必須能夠修改群組的名稱、說明、和關聯的訊息類型
- **FR-016**: 管理員必須能夠停用或啟用群組，停用後該群組的所有成員暫停接收該群組的訊息
- **FR-017**: 管理員必須能夠刪除群組，但必須先移除所有群組成員
- **FR-018**: 管理員必須能夠將使用者加入或移出群組，支援批次操作
- **FR-019**: 管理員必須能夠為群組設定來源主機篩選（支援萬用字元，如 web-server-*）
- **FR-020**: 管理員必須能夠為群組設定來源服務篩選（支援萬用字元）
- **FR-021**: 管理員必須能夠為群組設定接收時段（預設為全天 00:00-24:00）
- **FR-022**: 管理員必須能夠為群組設定靜音時段（預設為無）
- **FR-023**: 管理員必須能夠為群組設定是否接收重複告警，並設定重複告警間隔（預設為 30 分鐘）
- **FR-024**: 一位使用者可以同時屬於多個群組

#### 訊息類型管理

- **FR-025**: 系統必須提供預設的訊息類型：CRITICAL、WARNING、UNKNOWN、OK、INFO
- **FR-026**: 管理員必須能夠新增自訂訊息類型，包括代碼、名稱、說明、優先級、顏色、圖示
- **FR-027**: 管理員必須能夠修改自訂訊息類型的屬性
- **FR-028**: 管理員必須能夠停用或啟用訊息類型，停用後該類型的訊息不會被發送
- **FR-029**: 管理員必須能夠刪除自訂訊息類型，但系統預設類型不可刪除
- **FR-030**: 系統必須根據訊息類型的優先級進行排序顯示（1 為最高，5 為最低）

#### 訂閱管理（由管理員透過群組完全控制）

- **FR-031**: 使用者的訊息訂閱必須完全由管理員透過群組設定來決定，使用者無法自行訂閱或取消訂閱訊息類型
- **FR-032**: 當管理員將使用者加入群組時，系統必須自動為該使用者建立對應的訂閱（根據群組關聯的訊息類型）
- **FR-033**: 當管理員將使用者從群組移除時，系統必須自動移除該使用者對應的訂閱
- **FR-034**: 使用者必須能夠查看自己所屬的群組以及透過群組訂閱的訊息類型（唯讀，無法修改）
- **FR-035**: 當群組的訊息類型關聯變更時，系統必須自動更新所有群組成員的訂閱

#### 訊息發送

- **FR-036**: 系統必須提供 RESTful API 端點 `POST /api/v1/messages/send` 供外部系統發送訊息
- **FR-037**: API 必須使用 Bearer Token（API Key）進行認證
- **FR-038**: API 必須接受 JSON 格式的訊息內容，包括 messageType、title、content、source、metadata、targetGroups、priority
- **FR-039**: 系統必須驗證訊息類型是否有效且已啟用
- **FR-040**: 系統必須根據訊息類型查詢所有訂閱該類型的使用者
- **FR-041**: 系統必須套用群組的接收時段設定，在非接收時段內不發送訊息
- **FR-042**: 系統必須套用群組的靜音時段設定，在靜音時段內不發送訊息
- **FR-043**: 系統必須套用群組的來源主機篩選，只發送符合篩選條件的訊息
- **FR-044**: 系統必須套用群組的來源服務篩選，只發送符合篩選條件的訊息
- **FR-045**: 當 API 請求指定 targetGroups 時，系統必須只發送給指定群組的成員
- **FR-046**: 系統必須對同一使用者進行去重處理，即使該使用者符合多個發送條件，也只發送一則訊息
- **FR-047**: 系統必須使用非同步背景處理機制發送訊息，避免同步發送造成 API 回應延遲
- **FR-048**: 系統必須在 API 回應中返回訊息 ID、接收者數量、以及成功/失敗狀態
- **FR-049**: 系統必須使用 Line Messaging API 發送訊息到使用者的 Line 帳號
- **FR-050**: 系統必須使用 Flex Message 格式化告警訊息，包含訊息類型圖示、標題、來源資訊、內容、時間戳記
- **FR-051**: 系統必須在訊息發送失敗時啟用重試機制，重試 3 次（間隔 1 秒、5 秒、30 秒）
- **FR-052**: 系統必須記錄每則訊息的發送狀態（pending、sent、failed、skipped）
- **FR-053**: 系統必須記錄發送失敗的錯誤訊息和重試次數

#### 重複告警處理

- **FR-054**: 當群組設定不接收重複告警時，系統必須檢查相同來源主機和服務的告警，並在設定的時間間隔內不重複發送給該群組成員

#### 訊息歷史與報表

- **FR-055**: 系統必須記錄所有發送的訊息，包括訊息內容、訊息類型、來源資訊、metadata、發送時間
- **FR-056**: 系統必須記錄每則訊息的所有接收者和發送狀態
- **FR-057**: 使用者必須能夠查詢自己收到的訊息歷史，依時間範圍、訊息類型、發送狀態篩選
- **FR-058**: 管理員必須能夠查詢所有訊息的發送歷史，依時間範圍、訊息類型、來源主機/服務、發送狀態篩選
- **FR-059**: 管理員必須能夠查看統計報表，包括每日/週/月發送量、各類型訊息分布、發送成功率、尖峰時段分析
- **FR-060**: 系統必須自動刪除超過 90 天的訊息紀錄和發送記錄，以控制資料庫容量

#### API Key 管理

- **FR-061**: 管理員必須能夠建立新的 API Key，並為其命名（如「Nagios Production」）
- **FR-062**: 系統必須產生唯一的 API Key，並只在建立時顯示一次（之後只顯示前綴）
- **FR-063**: 系統必須使用 SHA-256 雜湊儲存 API Key，不儲存明文
- **FR-064**: 系統必須記錄每個 API Key 的最後使用時間
- **FR-065**: 管理員必須能夠撤銷（刪除）API Key，撤銷後該 Key 立即失效
- **FR-066**: 管理員必須能夠查看所有 API Key 的列表，包括名稱、建立時間、最後使用時間、狀態

#### 系統設定與安全

- **FR-067**: 系統必須支援設定 Line Channel Access Token 和 Channel Secret
- **FR-068**: 系統必須實作 Rate Limiting，限制每個 IP 每分鐘最多 100 次 API 請求
- **FR-069**: 系統必須使用 HTTPS 進行所有 API 通訊
- **FR-070**: 系統必須記錄所有敏感操作的審計日誌，包括管理員操作、API Key 建立/撤銷、使用者停用/啟用

### Technical Constraints *(技術架構約束)*

- **TC-001**: 後端框架：.NET 10（C#），使用 ASP.NET Core Web API
- **TC-002**: 資料庫：MySQL 8.x，容器化部署，使用 Docker Volume 持久化資料
- **TC-003**: 部署方式：Docker / Docker Compose，支援容器編排
- **TC-004**: 前端架構：使用者介面與管理後台整合為同一套應用，依角色（使用者/管理員）顯示不同介面
- **TC-005**: ORM：Entity Framework Core，支援 Code First 遷移
- **TC-006**: 非同步處理：使用 .NET 內建的 BackgroundService 或 IHostedService 處理背景任務（訊息發送、重試機制、資料清理）

### Key Entities *(include if feature involves data)*

- **User（使用者）**: 代表透過 Line Login 註冊的使用者。使用者只能進行登入註冊和查看自己的資訊，所有接收設定都由管理員透過群組控制。關鍵屬性包括 Line User ID（唯一識別）、顯示名稱、頭像 URL、Email（可選）、帳號狀態（啟用/停用）、是否為管理員、註冊時間、最後登入時間。與 Group、Subscription、MessageDelivery 有關聯。

- **Admin（管理員）**: 代表可以登入後台的管理員帳號。關鍵屬性包括帳號名稱、密碼雜湊、顯示名稱、是否為超級管理員、帳號狀態、是否需強制修改密碼、關聯的 Line 使用者 ID（可選）。

- **Group（群組）**: 代表使用者的分類群組，是系統的核心管理單位。所有接收設定都在群組層級進行，包括關聯的訊息類型、來源篩選、接收時段、重複告警處理等。關鍵屬性包括群組代碼（唯一）、群組名稱、說明、來源主機篩選、來源服務篩選、接收時段（開始/結束）、靜音時段（開始/結束）、是否接收重複告警、重複告警間隔、啟用狀態。與 User（多對多）、MessageType（多對多）有關聯。

- **MessageType（訊息類型）**: 代表告警的類型分類。關鍵屬性包括類型代碼（唯一，如 CRITICAL）、類型名稱、說明、優先級（1-5）、顏色（十六進位）、圖示、是否為系統預設類型、啟用狀態。與 Subscription、Message 有關聯。

- **Subscription（訂閱）**: 代表使用者透過群組訂閱的訊息類型設定。訂閱由系統自動建立（當使用者被加入群組時），使用者無法自行建立、修改或刪除訂閱。關鍵屬性包括關聯的使用者、關聯的訊息類型、關聯的群組（必填）、啟用狀態。一個使用者可以有多個訂閱（來自不同群組），一個訂閱只針對一個訊息類型。

- **Message（訊息）**: 代表一則待發送或已發送的告警訊息。關鍵屬性包括關聯的訊息類型、標題、內容、來源主機、來源服務、來源 IP、metadata（JSON 格式）、優先級（high/normal/low）、建立時間。與 MessageDelivery（一對多）有關聯。

- **MessageDelivery（訊息發送記錄）**: 代表一則訊息對特定使用者的發送記錄。關鍵屬性包括關聯的訊息、關聯的使用者、發送狀態（pending/sent/failed/skipped）、Line 訊息 ID、發送時間、錯誤訊息、重試次數。一則訊息可以對應多個發送記錄（每個接收者一筆）。

- **ApiKey（API 金鑰）**: 代表外部系統用於呼叫 API 的認證金鑰。關鍵屬性包括關聯的使用者（建立者）、金鑰名稱、金鑰雜湊（SHA-256）、金鑰前綴（用於顯示）、權限設定（JSON）、啟用狀態、過期時間、最後使用時間。

- **LoginLog（登入記錄）**: 代表使用者的登入歷史。關鍵屬性包括關聯的使用者、IP 位址、User Agent、登入時間、是否成功。用於審計和安全監控。

## Clarifications

### Session 2025-12-31

- Q: 訊息與發送記錄的資料保留期限為何？ → A: 保留 90 天，超過後自動刪除
- Q: 系統應如何實作聚合發送的定時觸發？ → A: 取消聚合發送功能
- Q: 系統預計的部署環境為何？ → A: 容器化部署（Docker/Docker Compose）
- Q: 系統應使用何種資料庫？ → A: MySQL（Docker 容器化），使用 Docker Volume 持久化資料
- Q: 系統後端應使用何種開發語言/框架？ → A: .NET 10（C#）
- Q: 使用者端介面應如何實作？ → A: 整合至管理後台，依角色顯示不同介面

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者從點擊「使用 Line 登入」到完成註冊並看到「等待管理員分配群組」頁面的整個流程，必須在 30 秒內完成
- **SC-002**: 從外部系統透過 API 發送訊息到使用者透過 Line 收到通知，端到端延遲必須在 3 秒內（95th percentile）
- **SC-003**: API 回應時間必須在 500 毫秒內（95th percentile）
- **SC-004**: 系統必須支援 100 個並發的 API 請求而不出現錯誤或明顯效能下降
- **SC-005**: 系統必須支援每日至少 10,000 則訊息的發送量
- **SC-006**: 訊息發送成功率必須達到 99.5% 以上（排除使用者主動取消 Line 好友關係的情況）
- **SC-007**: 當訊息發送失敗時，系統必須在 30 秒內完成 3 次重試嘗試
- **SC-008**: 90% 的使用者能夠在首次使用時，不需要額外說明就能完成 Line 登入註冊
- **SC-009**: 管理員能夠在 3 分鐘內完成建立群組、設定群組的所有接收規則（訊息類型、時段、重複告警等）、並加入成員的完整流程
- **SC-010**: 系統可用性必須達到 99.5%（每月允許約 3.6 小時的計畫性或非計畫性停機）
- **SC-011**: 資料庫必須每日自動備份，備份檔案必須保留 30 天
- **SC-012**: 相較於傳統簡訊服務，使用 Line 發送告警的成本必須降低至少 95%（假設簡訊每則 3 元，Line 訊息免費）
- **SC-013**: 系統必須正確處理群組的來源篩選設定，確保群組成員只收到符合篩選條件的告警（篩選準確率 100%）
- **SC-014**: 使用者對告警訊息的回應時間（從收到通知到開始處理問題）必須比傳統簡訊快至少 50%（透過使用者調查或日誌分析驗證）
