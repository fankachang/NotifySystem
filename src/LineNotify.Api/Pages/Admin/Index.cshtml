@page
@{
    Layout = "/Pages/Admin/_Layout.cshtml";
    ViewData["Title"] = "ç®¡ç†æ§åˆ¶å°";
}

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">ğŸ  ç®¡ç†æ§åˆ¶å°</h1>
        <div class="text-sm text-gray-500">
            æœ€å¾Œæ›´æ–°: <span id="lastUpdate">-</span>
            <button onclick="refreshDashboard()" class="ml-2 text-blue-500 hover:text-blue-700">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
    </div>

    <!-- å¿«é€Ÿçµ±è¨ˆ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-80">ç¸½ç”¨æˆ¶æ•¸</div>
                    <div class="text-3xl font-bold" id="totalUsers">-</div>
                </div>
                <div class="text-4xl opacity-50">ğŸ‘¥</div>
            </div>
            <div class="mt-2 text-sm opacity-80">
                ä»Šæ—¥æ–°å¢: <span id="newUsersToday">0</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-80">ç¸½ç¾¤çµ„æ•¸</div>
                    <div class="text-3xl font-bold" id="totalGroups">-</div>
                </div>
                <div class="text-4xl opacity-50">ğŸ“</div>
            </div>
            <div class="mt-2 text-sm opacity-80">
                æ´»èºç¾¤çµ„: <span id="activeGroups">0</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-80">ä»Šæ—¥è¨Šæ¯</div>
                    <div class="text-3xl font-bold" id="todayMessages">-</div>
                </div>
                <div class="text-4xl opacity-50">ğŸ“§</div>
            </div>
            <div class="mt-2 text-sm opacity-80">
                æˆåŠŸç‡: <span id="todaySuccessRate">-</span>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-80">å¾…è™•ç†è¨Šæ¯</div>
                    <div class="text-3xl font-bold" id="pendingMessages">-</div>
                </div>
                <div class="text-4xl opacity-50">â³</div>
            </div>
            <div class="mt-2 text-sm opacity-80">
                å¤±æ•—é‡è©¦: <span id="retryCount">0</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-lg font-semibold mb-4">âš¡ ç³»çµ±ç‹€æ…‹</h2>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">API æœå‹™</span>
                    <span id="apiStatus" class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">é‹ä½œä¸­</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">è³‡æ–™åº«é€£ç·š</span>
                    <span id="dbStatus" class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">æ­£å¸¸</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">LINE API é…é¡</span>
                    <div class="flex items-center">
                        <div class="w-32 h-2 bg-gray-200 rounded-full mr-2">
                            <div id="lineQuotaBar" class="h-full bg-blue-500 rounded-full" style="width: 15%"></div>
                        </div>
                        <span id="lineQuota" class="text-sm text-gray-500">150 / 1000</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">èƒŒæ™¯æœå‹™</span>
                    <span id="bgServiceStatus" class="px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">é‹ä½œä¸­</span>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-lg font-semibold mb-4">ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
            <div class="grid grid-cols-2 gap-4">
                <a href="/Admin/Users" class="flex items-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                    <span class="text-2xl mr-3">ğŸ‘¥</span>
                    <div>
                        <div class="font-medium">ç”¨æˆ¶ç®¡ç†</div>
                        <div class="text-sm text-gray-500">æŸ¥çœ‹èˆ‡ç·¨è¼¯ç”¨æˆ¶</div>
                    </div>
                </a>
                <a href="/Admin/Groups" class="flex items-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                    <span class="text-2xl mr-3">ğŸ“</span>
                    <div>
                        <div class="font-medium">ç¾¤çµ„ç®¡ç†</div>
                        <div class="text-sm text-gray-500">ç®¡ç†è¨‚é–±ç¾¤çµ„</div>
                    </div>
                </a>
                <a href="/Admin/Messages" class="flex items-center p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
                    <span class="text-2xl mr-3">ğŸ“§</span>
                    <div>
                        <div class="font-medium">è¨Šæ¯è¨˜éŒ„</div>
                        <div class="text-sm text-gray-500">æŸ¥çœ‹ç™¼é€è¨˜éŒ„</div>
                    </div>
                </a>
                <a href="/Admin/Reports" class="flex items-center p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition">
                    <span class="text-2xl mr-3">ğŸ“Š</span>
                    <div>
                        <div class="font-medium">å ±è¡¨åˆ†æ</div>
                        <div class="text-sm text-gray-500">çµ±è¨ˆèˆ‡åˆ†æ</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- æœ€è¿‘è¨Šæ¯ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">ğŸ“¨ æœ€è¿‘è¨Šæ¯</h2>
                <a href="/Admin/Messages" class="text-sm text-blue-500 hover:text-blue-700">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
            </div>
            <div id="recentMessages" class="space-y-3">
                <div class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- æœ€è¿‘æ“ä½œè¨˜éŒ„ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">ğŸ“‹ æœ€è¿‘æ“ä½œè¨˜éŒ„</h2>
                <a href="/Admin/AuditLogs" class="text-sm text-blue-500 hover:text-blue-700">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
            </div>
            <div id="recentLogs" class="space-y-3">
                <div class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
});

async function refreshDashboard() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
    
    await Promise.all([
        loadSummary(),
        loadSystemStatus(),
        loadRecentMessages(),
        loadRecentLogs()
    ]);
}

async function loadSummary() {
    try {
        const data = await adminFetch('/api/v1/admin/reports/summary');
        if (data.success) {
            const s = data.data;
            document.getElementById('totalUsers').textContent = s.totalUsers.toLocaleString();
            document.getElementById('totalGroups').textContent = s.totalGroups.toLocaleString();
            document.getElementById('activeGroups').textContent = s.activeGroups?.toLocaleString() || s.totalGroups.toLocaleString();
        }
    } catch (error) {
        console.error('Error:', error);
    }
    
    try {
        const data = await adminFetch('/api/v1/admin/reports/delivery-stats?days=1');
        if (data.success) {
            const s = data.data;
            document.getElementById('todayMessages').textContent = s.total.toLocaleString();
            document.getElementById('pendingMessages').textContent = s.pending.toLocaleString();
            document.getElementById('retryCount').textContent = s.failed.toLocaleString();
            
            const rate = s.total > 0 ? ((s.sent / s.total) * 100).toFixed(1) : '100';
            document.getElementById('todaySuccessRate').textContent = `${rate}%`;
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadSystemStatus() {
    try {
        const data = await adminFetch('/api/v1/admin/reports/overview');
        if (data.success) {
            const o = data.data;
            document.getElementById('newUsersToday').textContent = o.newUsersToday?.toLocaleString() || '0';
            
            // æ›´æ–°ç³»çµ±ç‹€æ…‹ï¼ˆæ¨¡æ“¬ï¼‰
            updateStatusBadge('apiStatus', true);
            updateStatusBadge('dbStatus', true);
            updateStatusBadge('bgServiceStatus', true);
        }
    } catch (error) {
        console.error('Error:', error);
        updateStatusBadge('apiStatus', false);
    }
}

function updateStatusBadge(elementId, isHealthy) {
    const element = document.getElementById(elementId);
    if (isHealthy) {
        element.className = 'px-3 py-1 rounded-full text-sm bg-green-100 text-green-800';
        element.textContent = 'æ­£å¸¸';
    } else {
        element.className = 'px-3 py-1 rounded-full text-sm bg-red-100 text-red-800';
        element.textContent = 'ç•°å¸¸';
    }
}

async function loadRecentMessages() {
    try {
        const data = await adminFetch('/api/v1/admin/messages?pageSize=5');
        if (data.success) {
            const container = document.getElementById('recentMessages');
            const messages = data.data.items;
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš«ç„¡è¨Šæ¯</div>';
                return;
            }
            
            container.innerHTML = messages.map(m => `
                <div class="flex items-center justify-between py-2 border-b last:border-0">
                    <div class="flex items-center">
                        ${getStatusDot(m.status)}
                        <div class="ml-3">
                            <div class="text-sm font-medium truncate max-w-xs">${escapeHtml(m.subject || '(ç„¡ä¸»æ—¨)')}</div>
                            <div class="text-xs text-gray-500">${m.groupName || 'å…¨é«”'}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">${formatTime(m.createdAt)}</div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadRecentLogs() {
    try {
        const data = await adminFetch('/api/v1/admin/audit-logs?pageSize=5');
        if (data.success) {
            const container = document.getElementById('recentLogs');
            const logs = data.data.items;
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš«ç„¡è¨˜éŒ„</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="flex items-center justify-between py-2 border-b last:border-0">
                    <div>
                        <span class="text-sm">${log.adminUsername || 'ç³»çµ±'}</span>
                        <span class="text-gray-400 mx-1">åŸ·è¡Œ</span>
                        <span class="px-2 py-0.5 text-xs rounded ${getActionClass(log.action)}">${log.action}</span>
                    </div>
                    <div class="text-xs text-gray-400">${formatTime(log.createdAt)}</div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function getStatusDot(status) {
    const colors = {
        'Pending': 'bg-yellow-400',
        'Sent': 'bg-green-400',
        'Failed': 'bg-red-400'
    };
    return `<div class="w-2 h-2 rounded-full ${colors[status] || 'bg-gray-400'}"></div>`;
}

function getActionClass(action) {
    if (action.includes('Create') || action.includes('Add')) return 'bg-green-100 text-green-800';
    if (action.includes('Delete') || action.includes('Remove')) return 'bg-red-100 text-red-800';
    if (action.includes('Update') || action.includes('Edit')) return 'bg-blue-100 text-blue-800';
    return 'bg-gray-100 text-gray-800';
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'å‰›å‰›';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} åˆ†é˜å‰`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} å°æ™‚å‰`;
    return date.toLocaleDateString('zh-TW');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
}
