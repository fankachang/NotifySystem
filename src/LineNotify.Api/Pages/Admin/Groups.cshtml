@page
@{
    Layout = "/Pages/Admin/_Layout.cshtml";
    ViewData["Title"] = "ç¾¤çµ„ç®¡ç†";
}

<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">ğŸ“ ç¾¤çµ„ç®¡ç†</h1>
        <button onclick="openCreateModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            + æ–°å¢ç¾¤çµ„
        </button>
    </div>

    <div id="groupList" class="grid gap-4">
        <div class="bg-white rounded-lg p-6 shadow text-center text-gray-500">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<!-- å»ºç«‹/ç·¨è¼¯å°è©±æ¡† -->
<div id="groupModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-screen overflow-y-auto">
        <h3 id="modalTitle" class="text-lg font-semibold mb-4">æ–°å¢ç¾¤çµ„</h3>
        <form id="groupForm" class="space-y-4">
            <input type="hidden" id="groupId">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ç¾¤çµ„ä»£ç¢¼ *</label>
                    <input type="text" id="groupCode" required class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="ä¾‹ï¼šINFRA">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ç¾¤çµ„åç¨± *</label>
                    <input type="text" id="groupName" required class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="ä¾‹ï¼šåŸºç¤è¨­æ–½åœ˜éšŠ">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">èªªæ˜</label>
                <textarea id="groupDescription" class="mt-1 w-full px-3 py-2 border rounded-md" rows="2"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ä¾†æºä¸»æ©Ÿç¯©é¸</label>
                    <input type="text" id="hostFilter" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="ä¾‹ï¼šweb-server-*">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ä¾†æºæœå‹™ç¯©é¸</label>
                    <input type="text" id="serviceFilter" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="ä¾‹ï¼šHTTP">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ¥æ”¶æ™‚æ®µé–‹å§‹</label>
                    <input type="time" id="activeTimeStart" class="mt-1 w-full px-3 py-2 border rounded-md" value="00:00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æ¥æ”¶æ™‚æ®µçµæŸ</label>
                    <input type="time" id="activeTimeEnd" class="mt-1 w-full px-3 py-2 border rounded-md" value="23:59">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">è¨Šæ¯é¡å‹</label>
                <div id="messageTypeCheckboxes" class="mt-2 flex flex-wrap gap-2">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" id="suppressDuplicate" checked class="mr-2">
                    <span>æŠ‘åˆ¶é‡è¤‡å‘Šè­¦</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="isActive" checked class="mr-2">
                    <span>å•Ÿç”¨</span>
                </label>
            </div>
            <div class="flex justify-end space-x-2 pt-4 border-t">
                <button type="button" onclick="closeGroupModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">å„²å­˜</button>
            </div>
        </form>
    </div>
</div>

<!-- æˆå“¡ç®¡ç†å°è©±æ¡† -->
<div id="membersModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <h3 class="text-lg font-semibold mb-4">ç®¡ç†æˆå“¡ - <span id="membersGroupName"></span></h3>
        <input type="hidden" id="membersGroupId">
        
        <div class="mb-4">
            <h4 class="font-medium mb-2">ç›®å‰æˆå“¡</h4>
            <div id="currentMembers" class="flex flex-wrap gap-2">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="mb-4">
            <h4 class="font-medium mb-2">æ–°å¢æˆå“¡</h4>
            <div class="flex space-x-2">
                <select id="userSelect" class="flex-1 px-3 py-2 border rounded-md">
                    <option value="">é¸æ“‡ä½¿ç”¨è€…...</option>
                </select>
                <button type="button" onclick="addMember()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">åŠ å…¥</button>
            </div>
        </div>
        
        <div class="flex justify-end">
            <button type="button" onclick="closeMembersModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">é—œé–‰</button>
        </div>
    </div>
</div>

@section Scripts {
<script>
let messageTypes = [];

document.addEventListener('DOMContentLoaded', function() {
    loadGroups();
    loadMessageTypes();
    document.getElementById('groupForm').addEventListener('submit', handleGroupSubmit);
});

async function loadMessageTypes() {
    try {
        const data = await adminFetch('/api/v1/admin/message-types');
        if (data.success) {
            messageTypes = data.data;
            renderMessageTypeCheckboxes();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderMessageTypeCheckboxes() {
    const container = document.getElementById('messageTypeCheckboxes');
    container.innerHTML = messageTypes.map(mt => `
        <label class="flex items-center px-3 py-1 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" name="messageTypes" value="${mt.id}" class="mr-2">
            <span style="color: ${mt.color}">${mt.icon || 'â—'}</span>
            <span class="ml-1">${mt.name}</span>
        </label>
    `).join('');
}

async function loadGroups() {
    try {
        const data = await adminFetch('/api/v1/admin/groups');
        if (data.success) {
            renderGroups(data.data);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderGroups(groups) {
    const container = document.getElementById('groupList');
    
    if (groups.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-lg p-6 shadow text-center text-gray-500">å°šæœªå»ºç«‹ä»»ä½•ç¾¤çµ„</div>';
        return;
    }
    
    container.innerHTML = groups.map(group => `
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        ${group.name}
                        <span class="text-sm font-normal text-gray-500">(${group.code})</span>
                        ${!group.isActive ? '<span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded">å·²åœç”¨</span>' : ''}
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">${group.description || 'ç„¡èªªæ˜'}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick='openMembersModal(${JSON.stringify(group).replace(/'/g, "\\'")})' 
                            class="text-green-600 hover:text-green-800">æˆå“¡</button>
                    <button onclick='openEditModal(${JSON.stringify(group).replace(/'/g, "\\'")})' 
                            class="text-blue-600 hover:text-blue-800">ç·¨è¼¯</button>
                    <button onclick="deleteGroup(${group.id})" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600">
                <span>ğŸ‘¥ ${group.memberCount || 0} ä½æˆå“¡</span>
                <span>ğŸ·ï¸ ${group.messageTypes?.map(mt => mt.name).join(', ') || 'ç„¡è¨Šæ¯é¡å‹'}</span>
                <span>â° ${group.activeTimeStart || '00:00'} - ${group.activeTimeEnd || '23:59'}</span>
            </div>
        </div>
    `).join('');
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'æ–°å¢ç¾¤çµ„';
    document.getElementById('groupForm').reset();
    document.getElementById('groupId').value = '';
    document.getElementById('isActive').checked = true;
    document.getElementById('suppressDuplicate').checked = true;
    document.querySelectorAll('input[name="messageTypes"]').forEach(cb => cb.checked = false);
    document.getElementById('groupModal').classList.remove('hidden');
}

function openEditModal(group) {
    document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¾¤çµ„';
    document.getElementById('groupId').value = group.id;
    document.getElementById('groupCode').value = group.code;
    document.getElementById('groupName').value = group.name;
    document.getElementById('groupDescription').value = group.description || '';
    document.getElementById('hostFilter').value = group.hostFilter || '';
    document.getElementById('serviceFilter').value = group.serviceFilter || '';
    document.getElementById('activeTimeStart').value = group.activeTimeStart || '00:00';
    document.getElementById('activeTimeEnd').value = group.activeTimeEnd || '23:59';
    document.getElementById('isActive').checked = group.isActive;
    document.getElementById('suppressDuplicate').checked = group.suppressDuplicate;
    
    // è¨­å®šè¨Šæ¯é¡å‹å‹¾é¸
    document.querySelectorAll('input[name="messageTypes"]').forEach(cb => {
        cb.checked = group.messageTypes?.some(mt => mt.id == cb.value);
    });
    
    document.getElementById('groupModal').classList.remove('hidden');
}

function closeGroupModal() {
    document.getElementById('groupModal').classList.add('hidden');
}

async function handleGroupSubmit(e) {
    e.preventDefault();
    
    const groupId = document.getElementById('groupId').value;
    const isEdit = !!groupId;
    
    const selectedMessageTypes = Array.from(document.querySelectorAll('input[name="messageTypes"]:checked'))
        .map(cb => parseInt(cb.value));
    
    const data = {
        code: document.getElementById('groupCode').value,
        name: document.getElementById('groupName').value,
        description: document.getElementById('groupDescription').value || null,
        hostFilter: document.getElementById('hostFilter').value || null,
        serviceFilter: document.getElementById('serviceFilter').value || null,
        activeTimeStart: document.getElementById('activeTimeStart').value,
        activeTimeEnd: document.getElementById('activeTimeEnd').value,
        isActive: document.getElementById('isActive').checked,
        suppressDuplicate: document.getElementById('suppressDuplicate').checked,
        messageTypeIds: selectedMessageTypes
    };
    
    try {
        const url = isEdit ? `/api/v1/admin/groups/${groupId}` : '/api/v1/admin/groups';
        const method = isEdit ? 'PUT' : 'POST';
        
        const result = await adminFetch(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        if (result.success) {
            closeGroupModal();
            loadGroups();
        } else {
            alert(result.error?.message || 'æ“ä½œå¤±æ•—');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤');
    }
}

async function deleteGroup(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¾¤çµ„å—ï¼Ÿ')) return;
    
    try {
        const result = await adminFetch(`/api/v1/admin/groups/${id}`, { method: 'DELETE' });
        if (result.success) {
            loadGroups();
        } else {
            alert(result.error?.message || 'åˆªé™¤å¤±æ•—');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤');
    }
}

// æˆå“¡ç®¡ç†
async function openMembersModal(group) {
    document.getElementById('membersGroupId').value = group.id;
    document.getElementById('membersGroupName').textContent = group.name;
    document.getElementById('membersModal').classList.remove('hidden');
    
    await loadGroupMembers(group.id);
    await loadAvailableUsers();
}

function closeMembersModal() {
    document.getElementById('membersModal').classList.add('hidden');
}

async function loadGroupMembers(groupId) {
    try {
        const data = await adminFetch(`/api/v1/admin/groups/${groupId}`);
        if (data.success && data.data.members) {
            renderCurrentMembers(data.data.members);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function renderCurrentMembers(members) {
    const container = document.getElementById('currentMembers');
    if (members.length === 0) {
        container.innerHTML = '<span class="text-gray-500">å°šç„¡æˆå“¡</span>';
        return;
    }
    
    container.innerHTML = members.map(m => `
        <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded">
            ${m.userName || m.displayName}
            <button onclick="removeMember(${m.userId || m.id})" class="ml-2 text-red-600 hover:text-red-800">&times;</button>
        </span>
    `).join('');
}

async function loadAvailableUsers() {
    try {
        const data = await adminFetch('/api/v1/admin/users?pageSize=100');
        if (data.success && data.data && data.data.items) {
            const select = document.getElementById('userSelect');
            const validUsers = data.data.items.filter(u => u.id && u.id > 0);
            console.log('Available users:', validUsers); // é™¤éŒ¯ç”¨
            select.innerHTML = '<option value="">é¸æ“‡ä½¿ç”¨è€…...</option>' +
                validUsers.map(u => `<option value="${u.id}">${u.displayName} (ID: ${u.id})</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function addMember() {
    const groupId = document.getElementById('membersGroupId').value;
    const userSelect = document.getElementById('userSelect');
    const userId = userSelect.value;
    
    if (!userId || userId === '0' || userId === '') {
        alert('è«‹é¸æ“‡ä½¿ç”¨è€…');
        return;
    }
    
    const userIdNum = parseInt(userId, 10);
    if (isNaN(userIdNum) || userIdNum <= 0) {
        alert('ç„¡æ•ˆçš„ä½¿ç”¨è€… ID');
        return;
    }
    
    try {
        const result = await adminFetch(`/api/v1/admin/groups/${groupId}/members`, {
            method: 'POST',
            body: JSON.stringify({ userId: userIdNum })
        });
        
        if (result.success) {
            loadGroupMembers(groupId);
            loadGroups();
            // é‡è¨­ä¸‹æ‹‰é¸å–®
            userSelect.value = '';
        } else {
            alert(result.error?.message || 'æ–°å¢å¤±æ•—');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤');
    }
}

async function removeMember(userId) {
    const groupId = document.getElementById('membersGroupId').value;
    
    if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤æˆå“¡å—ï¼Ÿ')) return;
    
    try {
        const result = await adminFetch(`/api/v1/admin/groups/${groupId}/members/${userId}`, {
            method: 'DELETE'
        });
        
        if (result.success) {
            loadGroupMembers(groupId);
            loadGroups();
        } else {
            alert(result.error?.message || 'ç§»é™¤å¤±æ•—');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤');
    }
}
</script>
}
