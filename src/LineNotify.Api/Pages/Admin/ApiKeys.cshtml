@page
@{
    Layout = "/Pages/Admin/_Layout.cshtml";
    ViewData["Title"] = "API Key 管理";
}

<div class="container mx-auto">
    <!-- 頁面標題與操作區 -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">API Key 管理</h1>
            <p class="text-gray-600 mt-1">管理外部系統存取的 API 金鑰</p>
        </div>
        <button onclick="showCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            建立新金鑰
        </button>
    </div>

    <!-- 統計卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">總金鑰數</div>
            <div id="stat-total" class="text-2xl font-bold text-gray-800">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">啟用中</div>
            <div id="stat-active" class="text-2xl font-bold text-green-600">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">已過期/撤銷</div>
            <div id="stat-expired" class="text-2xl font-bold text-red-600">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-500">總使用次數</div>
            <div id="stat-usage" class="text-2xl font-bold text-blue-600">-</div>
        </div>
    </div>

    <!-- 搜尋與篩選 -->
    <div class="bg-white rounded-lg shadow mb-6 p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">搜尋</label>
                <input type="text" id="search" placeholder="名稱、描述或金鑰前綴" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       onkeypress="if(event.key === 'Enter') loadApiKeys()">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="loadApiKeys()">
                    <option value="">全部</option>
                    <option value="true">啟用中</option>
                    <option value="false">已停用</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="loadApiKeys()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                    搜尋
                </button>
            </div>
        </div>
    </div>

    <!-- API Key 列表 -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金鑰前綴</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用統計</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">建立資訊</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                </tr>
            </thead>
            <tbody id="api-keys-table" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">載入中...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 分頁 -->
    <div id="pagination" class="flex justify-between items-center mt-4">
        <div id="page-info" class="text-sm text-gray-600"></div>
        <div id="page-buttons" class="flex space-x-2"></div>
    </div>
</div>

<!-- 建立 Modal -->
<div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">建立新 API Key</h2>
                <button onclick="hideCreateModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="createForm" onsubmit="createApiKey(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">名稱 *</label>
                        <input type="text" id="create-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="例如：Nagios Production">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                        <textarea id="create-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="用途說明"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">有效期限</label>
                        <select id="create-expires" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">永不過期</option>
                            <option value="30">30 天</option>
                            <option value="90">90 天</option>
                            <option value="180">180 天</option>
                            <option value="365">1 年</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideCreateModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        建立
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 顯示金鑰 Modal -->
<div id="keyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-green-600">API Key 已建立</h2>
                <button onclick="hideKeyModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div class="text-sm text-yellow-800">
                        <strong>請立即複製此金鑰！</strong><br>
                        此金鑰只會顯示這一次，之後將無法再次查看。
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <div class="flex">
                    <input type="text" id="new-api-key" readonly
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50 font-mono text-sm">
                    <button onclick="copyApiKey()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">
                        複製
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-600 mb-4">
                <p>使用方式：在 HTTP 請求標頭加入</p>
                <code class="block bg-gray-100 p-2 rounded mt-1 text-xs">
                    X-API-Key: &lt;your-api-key&gt;
                </code>
            </div>
            <div class="flex justify-end">
                <button onclick="hideKeyModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    我已儲存金鑰
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 編輯 Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">編輯 API Key</h2>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="editForm" onsubmit="updateApiKey(event)">
                <input type="hidden" id="edit-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">名稱 *</label>
                        <input type="text" id="edit-name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                        <textarea id="edit-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                        <select id="edit-active" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="true">啟用</option>
                            <option value="false">停用</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">過期時間</label>
                        <input type="datetime-local" id="edit-expires"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">留空表示永不過期</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideEditModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 詳情 Modal -->
<div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">API Key 詳情</h2>
                <button onclick="hideDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="detail-content" class="space-y-4">
                <!-- 動態填入 -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="hideDetailModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    關閉
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentPage = 1;
    const pageSize = 10;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadApiKeys();
    });

    // adminFetch 輔助函數
    async function adminFetch(url, options = {}) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
        };

        const fetchOptions = {
            ...options,
            headers
        };

        const response = await fetch(url, fetchOptions);
        
        if (response.status === 401) {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
            return;
        }

        return response;
    }

    // 載入統計
    async function loadStats() {
        try {
            const response = await adminFetch('/api/v1/admin/api-keys/stats');
            if (response && response.ok) {
                const data = await response.json();
                document.getElementById('stat-total').textContent = data.totalCount;
                document.getElementById('stat-active').textContent = data.activeCount;
                document.getElementById('stat-expired').textContent = data.expiredCount + data.revokedCount;
                document.getElementById('stat-usage').textContent = data.totalUsage.toLocaleString();
            }
        } catch (error) {
            console.error('載入統計失敗:', error);
        }
    }

    // 載入 API Key 列表
    async function loadApiKeys(page = 1) {
        currentPage = page;
        const search = document.getElementById('search').value;
        const status = document.getElementById('status').value;

        let url = `/api/v1/admin/api-keys?page=${page}&pageSize=${pageSize}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (status) url += `&isActive=${status}`;

        try {
            const response = await adminFetch(url);
            if (response && response.ok) {
                const data = await response.json();
                renderTable(data.items);
                renderPagination(data.pagination);
            }
        } catch (error) {
            console.error('載入 API Keys 失敗:', error);
            document.getElementById('api-keys-table').innerHTML = 
                '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">載入失敗</td></tr>';
        }
    }

    // 渲染表格
    function renderTable(items) {
        const tbody = document.getElementById('api-keys-table');
        
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">尚無資料</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="font-medium text-gray-900">${escapeHtml(item.name)}</div>
                    ${item.description ? `<div class="text-sm text-gray-500">${escapeHtml(item.description)}</div>` : ''}
                </td>
                <td class="px-6 py-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">${escapeHtml(item.keyPrefix)}</code>
                </td>
                <td class="px-6 py-4">
                    ${getStatusBadge(item)}
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm">
                        <div>使用 <span class="font-medium">${item.usageCount.toLocaleString()}</span> 次</div>
                        ${item.lastUsedAt 
                            ? `<div class="text-gray-500">最後：${formatDate(item.lastUsedAt)}</div>` 
                            : '<div class="text-gray-400">尚未使用</div>'}
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm">
                        <div>${formatDate(item.createdAt)}</div>
                        <div class="text-gray-500">by ${escapeHtml(item.createdByName)}</div>
                    </div>
                </td>
                <td class="px-6 py-4 text-right space-x-2">
                    <button onclick="showDetail(${item.id})" class="text-blue-600 hover:text-blue-800" title="詳情">
                        <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                    <button onclick="showEditModal(${item.id})" class="text-yellow-600 hover:text-yellow-800" title="編輯">
                        <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    ${item.isActive && !item.isExpired ? `
                        <button onclick="revokeKey(${item.id}, '${escapeHtml(item.name)}')" class="text-orange-600 hover:text-orange-800" title="撤銷">
                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                            </svg>
                        </button>
                    ` : ''}
                    <button onclick="deleteKey(${item.id}, '${escapeHtml(item.name)}')" class="text-red-600 hover:text-red-800" title="刪除">
                        <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // 取得狀態徽章
    function getStatusBadge(item) {
        if (item.isExpired) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">已過期</span>';
        }
        if (!item.isActive) {
            return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">已撤銷</span>';
        }
        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">啟用中</span>';
    }

    // 渲染分頁
    function renderPagination(pagination) {
        const info = document.getElementById('page-info');
        const buttons = document.getElementById('page-buttons');

        const currentPage = pagination.page || pagination.currentPage || 1;
        const pageSize = pagination.pageSize || 10;
        const totalItems = pagination.totalItems || pagination.totalCount || 0;
        const totalPages = pagination.totalPages || Math.ceil(totalItems / pageSize) || 1;

        const start = totalItems > 0 ? (currentPage - 1) * pageSize + 1 : 0;
        const end = Math.min(currentPage * pageSize, totalItems);
        info.textContent = `顯示 ${start}-${end} 筆，共 ${totalItems} 筆`;

        let html = '';
        if (currentPage > 1) {
            html += `<button onclick="loadApiKeys(${currentPage - 1})" class="px-3 py-1 border rounded hover:bg-gray-50">上一頁</button>`;
        }
        html += `<span class="px-3 py-1">第 ${currentPage} / ${totalPages} 頁</span>`;
        if (currentPage < totalPages) {
            html += `<button onclick="loadApiKeys(${currentPage + 1})" class="px-3 py-1 border rounded hover:bg-gray-50">下一頁</button>`;
        }
        buttons.innerHTML = html;
    }

    // 建立 Modal
    function showCreateModal() {
        document.getElementById('createForm').reset();
        document.getElementById('createModal').classList.remove('hidden');
    }

    function hideCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    // 建立 API Key
    async function createApiKey(event) {
        event.preventDefault();
        
        const name = document.getElementById('create-name').value.trim();
        const description = document.getElementById('create-description').value.trim();
        const expiresInDays = document.getElementById('create-expires').value;

        const body = {
            name,
            description: description || null,
            expiresInDays: expiresInDays ? parseInt(expiresInDays) : null
        };

        try {
            const response = await adminFetch('/api/v1/admin/api-keys', {
                method: 'POST',
                body: JSON.stringify(body)
            });

            if (!response) {
                return;
            }

            if (response.ok) {
                const data = await response.json();
                hideCreateModal();
                
                // 顯示金鑰
                document.getElementById('new-api-key').value = data.apiKey;
                document.getElementById('keyModal').classList.remove('hidden');
                
                loadStats();
                loadApiKeys();
            } else {
                const errorText = await response.text();
                let errorMessage = '未知錯誤';
                try {
                    const error = JSON.parse(errorText);
                    errorMessage = error.message || error.title || errorText;
                } catch {
                    errorMessage = errorText || response.statusText;
                }
                alert('建立失敗: ' + errorMessage);
            }
        } catch (error) {
            console.error('建立失敗:', error);
            alert('建立失敗: ' + error.message);
        }
    }

    // 金鑰 Modal
    function hideKeyModal() {
        document.getElementById('keyModal').classList.add('hidden');
    }

    function copyApiKey() {
        const input = document.getElementById('new-api-key');
        input.select();
        document.execCommand('copy');
        alert('已複製到剪貼簿！');
    }

    // 編輯 Modal
    async function showEditModal(id) {
        try {
            const response = await adminFetch(`/api/v1/admin/api-keys/${id}`);
            if (response && response.ok) {
                const data = await response.json();
                document.getElementById('edit-id').value = data.id;
                document.getElementById('edit-name').value = data.name;
                document.getElementById('edit-description').value = data.description || '';
                document.getElementById('edit-active').value = data.isActive.toString();
                if (data.expiresAt) {
                    const date = new Date(data.expiresAt);
                    document.getElementById('edit-expires').value = date.toISOString().slice(0, 16);
                } else {
                    document.getElementById('edit-expires').value = '';
                }
                document.getElementById('editModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('載入詳情失敗:', error);
            alert('載入失敗');
        }
    }

    function hideEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    async function updateApiKey(event) {
        event.preventDefault();

        const id = document.getElementById('edit-id').value;
        const expiresValue = document.getElementById('edit-expires').value;
        
        const body = {
            name: document.getElementById('edit-name').value.trim(),
            description: document.getElementById('edit-description').value.trim() || null,
            isActive: document.getElementById('edit-active').value === 'true',
            expiresAt: expiresValue ? new Date(expiresValue).toISOString() : null
        };

        try {
            const response = await adminFetch(`/api/v1/admin/api-keys/${id}`, {
                method: 'PUT',
                body: JSON.stringify(body)
            });

            if (response && response.ok) {
                hideEditModal();
                loadStats();
                loadApiKeys(currentPage);
                alert('更新成功');
            } else {
                const error = await response.json();
                alert('更新失敗: ' + (error.message || '未知錯誤'));
            }
        } catch (error) {
            console.error('更新失敗:', error);
            alert('更新失敗: ' + error.message);
        }
    }

    // 詳情 Modal
    async function showDetail(id) {
        try {
            const response = await adminFetch(`/api/v1/admin/api-keys/${id}`);
            if (response && response.ok) {
                const data = await response.json();
                
                const content = document.getElementById('detail-content');
                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-500">名稱</div>
                            <div class="font-medium">${escapeHtml(data.name)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">狀態</div>
                            <div>${data.isExpired ? '<span class="text-red-600">已過期</span>' : (data.isActive ? '<span class="text-green-600">啟用中</span>' : '<span class="text-gray-600">已撤銷</span>')}</div>
                        </div>
                        <div class="col-span-2">
                            <div class="text-sm text-gray-500">描述</div>
                            <div>${data.description ? escapeHtml(data.description) : '<span class="text-gray-400">無</span>'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">金鑰前綴</div>
                            <code class="bg-gray-100 px-2 py-1 rounded">${escapeHtml(data.keyPrefix)}</code>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">使用次數</div>
                            <div class="font-medium">${data.usageCount.toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">最後使用</div>
                            <div>${data.lastUsedAt ? formatDate(data.lastUsedAt) : '<span class="text-gray-400">尚未使用</span>'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">過期時間</div>
                            <div>${data.expiresAt ? formatDate(data.expiresAt) : '<span class="text-gray-400">永不過期</span>'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">建立時間</div>
                            <div>${formatDate(data.createdAt)}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">建立者</div>
                            <div>${escapeHtml(data.createdByName)}</div>
                        </div>
                    </div>
                    ${data.permissions ? `
                        <div class="mt-4 pt-4 border-t">
                            <div class="text-sm text-gray-500 mb-2">權限設定</div>
                            <div class="text-sm">
                                ${data.permissions.allowedMessageTypeIds?.length ? `<div>允許訊息類型: ${data.permissions.allowedMessageTypeIds.join(', ')}</div>` : ''}
                                ${data.permissions.allowedGroupIds?.length ? `<div>允許群組: ${data.permissions.allowedGroupIds.join(', ')}</div>` : ''}
                                ${!data.permissions.allowedMessageTypeIds?.length && !data.permissions.allowedGroupIds?.length ? '<div class="text-gray-400">無限制</div>' : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('detailModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('載入詳情失敗:', error);
            alert('載入失敗');
        }
    }

    function hideDetailModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }

    // 撤銷 API Key
    async function revokeKey(id, name) {
        if (!confirm(`確定要撤銷「${name}」嗎？撤銷後此金鑰將無法使用。`)) return;

        try {
            const response = await adminFetch(`/api/v1/admin/api-keys/${id}/revoke`, {
                method: 'POST'
            });

            if (response && response.ok) {
                loadStats();
                loadApiKeys(currentPage);
                alert('已撤銷');
            } else {
                const error = await response.json();
                alert('撤銷失敗: ' + (error.message || '未知錯誤'));
            }
        } catch (error) {
            console.error('撤銷失敗:', error);
            alert('撤銷失敗: ' + error.message);
        }
    }

    // 刪除 API Key
    async function deleteKey(id, name) {
        if (!confirm(`確定要刪除「${name}」嗎？此操作無法復原。`)) return;

        try {
            const response = await adminFetch(`/api/v1/admin/api-keys/${id}`, {
                method: 'DELETE'
            });

            if (response && response.ok) {
                loadStats();
                loadApiKeys(currentPage);
                alert('已刪除');
            } else {
                const error = await response.json();
                alert('刪除失敗: ' + (error.message || '未知錯誤'));
            }
        } catch (error) {
            console.error('刪除失敗:', error);
            alert('刪除失敗: ' + error.message);
        }
    }

    // 輔助函數
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}
